## 参考资料
 - [4.23 STM32 外设篇-红外线接收工作原理及程序设计  此博文包含图片	(2015-06-10 15:38:33)](http://blog.sina.com.cn/s/blog_8a4745370102vq8m.html)
 - [浅谈38K红外发射接受编码](http://www.voidcn.com/blog/u012993936/article/p-3554521.html)
 - [基于STM32的学习型通用红外遥控设备的设计实现(1~3)](http://blog.csdn.net/u013686019/article/details/19834441)
 - [STM32学习之路-AIRCR寄存器PRIGROUP位的配置](http://www.ithao123.cn/content-8377076.html)
 - [ STM32学习笔记：外部中断EXTI的使用](http://blog.csdn.net/u010173859/article/details/10179627)
 - [STM32学习笔记之EXTI（外部中断）](http://blog.sina.com.cn/s/blog_6623834301018woa.html)
 - [STM32中断优先级彻底讲解](https://wenku.baidu.com/view/4944282c915f804d2b16c18e.html)


# 电路说明

![](/Hardware/sche_overview.png)

上图是该硬件系统的完整电路图, 该电路共分为 7 个部分:

 1. 稳压电源电路
 2. 单片机启动配置电路
 3. 单片机外部时钟晶振电路
 4. 单片机上电复位电路
 5. 8 路学码部分电路
 6. 8 路发码部分电路
 7. 电路板接口电路

## 1. 稳压电源电路

稳压电源电路是用来将外部供电电源的电压转换成单片机所需的 3.3V 稳定的电压。

![](/Hardware/part_01.png)

这里使用了型号为 XC6206P332MR 的稳压 LDO 芯片, LDO即 Low Dropout Regulator，是一种低压差线性稳压器。并且在芯片的电源输入引脚和电源输出引脚分别接了两个滤波电容, 用来防止电源可能发生的波动, 提高数字电路工作的稳健性。


![](/Hardware/part_0101.png)
![](/Hardware/part_0102.png)

上图是该 LDO 芯片型号为 P302MR 的典型输入输出电压曲线, 横轴为输入电压, 纵轴为输出电压, 通过上图可以清楚的看出, 我们所使用的 P332MR 当输入电压在 3.4V ~ 6V 的范围内, 都可以输出稳定的 3.3V 电压。

(这张图表是XC6206P302的数据, 官方的数据手册中只有该型号的图表作为一个典型示例, 没有我们所使用的 P332MR, 所以图表中的输出电压不是3.3V)

## 2. 单片机启动配置电路

在STM32F10xxx里，可以通过BOOT[1:0]引脚选择三种不同启动模式:

![](/Hardware/part_0201.png)

- 从主闪存存储器启动: 主闪存存储器被映射到启动空间 (0x0000 0000), 但仍然能够在它原
有的地址 (0x0800 0000) 访问它, 即闪存存储器的内容可以在两个地址区域访问, 0x0000
0000 或 0x0800 0000。
> **以这种模式启动会运行用户烧写的程序**

- 从系统存储器启动：系统存储器被映射到启动空间 (0x0000 0000), 但仍然能够在它原有的
地址(互联型产品原有地址为 0x1FFF B000, 其它产品原有地址为0x1FFF F000)访问它。
> **以这种模式启动会运行单片机出厂自带的 ISP 程序(In System Program 在系统编程), 这时我们可以通过串口连接单片机来上传程序。**


在系统复位后, SYSCLK 的第4个上升沿, BOOT 引脚的值将被锁存。用户可以通过设置 BOOT1
 和 BOOT0 引脚的状态，来选择在复位后的启动模式。

 ![](/Hardware/part_02.png)

在这次设计中, 我们将 BOOT1 通过一个 10K 的限流电阻直接接地, 通过 BOOT0 来控制单片机的启动模式。在实际使用的过程中, 单片机默认会以第一种模式启动 (BOOT0 悬空时为低电平), 也就是运行用户的程序, 如果我们要烧写程序, 只需要在单片机供电时确保 BOOT0 为高电平, 如下图, 将电阻 R3 右侧短接上方电容 C7 左侧即可。

![](/Hardware/part_0202.png)

## 3. 单片机外部时钟晶振电路

![](/Hardware/part_03.png)

4~16Mz外部振荡器可为系统提供更为精确的主时钟, 在这里单片机的高速外部时钟信号 (HSE) 是由以下一个8Mhz晶振产生的。
晶振两个引脚分别连接单片机的外部时钟引脚, 并且连接了两个 20pF 的负载电容, 作用是对晶体和振荡电路的补偿和匹配, 使电路易于起振并处于合理的激励态下, 同时对振荡频率也有一定的微调作用; 同时晶振也并联了一个 1M 欧的电阻 R2, 起到分流作用, 使晶振的工作电流在一个合理的范围内。

## 4. 单片机上电复位电路


STM32 支持三种复位形式, 分别为系统复位、上电复位和备份区域复位, 这里的电路图属于上电复位。


![](/Hardware/part_0401.png)

芯片内部的复位信号源是单片机的 NRST 引脚, 脉冲发生器保证每一个(外部或内部)复位源都能有
至少20μs的脉冲延时; 当 NRST 引脚被拉低产生外部复位时, 它将产生复位脉冲, 然后单片机将会复位除了备份区域外的所有寄存器, 也就是清除上次运行后单片机配置可能发生的改变, 目的是让系统回到一个固定的初始状态, 这时所有寄存器的值都是已知的, 所以在这之后对单片机的每一次操作的结果都是可以判断的。

![](/Hardware/part_04.png)

上图是单片机的上电复位电路, RESET 连接在单片机的 NRST 引脚, 在电路板开始供电时电容 C9 两侧是短路的, 也就是说这时 RESET 是直接接地的, 为低电平, 随着时间的推移, 电容将会被上拉的限流电阻 R8 充电, 随后 RESET 到 GND 之间就会形成断路, 这时 RESET 会变为高电平, 在整个过程也就中产生了低电平的复位信号。

## 5. 8路学码部分电路

![](/Hardware/part_05.png)

上图为 8 路的学码电路, 每一路都连接了一个 VS838 红外接收管:

![](/Hardware/part_0501.png)

VS838 的电源管脚 VCC 通过一个限流电阻接电源。

VS838 的 OUT 管脚是信号输出管脚, 当 VS838 接受到红外信号时 OUT 管脚会由高电平变为低电平, 直到红外信号消失。(未收到红外信号时 OUT 脚一直为高电平)

![](/Hardware/part_0502.png) ![](/Hardware/part_0503.png)

红外信号输出管脚是单片机获取红外信号的唯一来源, 所以该管脚连接在单片机的 GPIO 上, 当收到红外信号时该管脚产生的电平翻转会被单片机的 GPIO 捕获并产生外部中断, 在中断函数中我们会记录该波形也就是红外信号的波形长度, 从而进行学码。

## 6. 8路发码部分电路

![](/Hardware/part_06.png)

上图为 8 路的发码电路, NEC标准规定: 红外通信的载波频率为38KHz, 占空比为1:3,

这里我们使用单片机定时器的 PWM 输出功能产生所需的 38KHz 1:3 波形, 通过对 PWM 输出的打开和关闭来实现载波。PWM 信号管脚通过一个限流电阻连接一个 NPN 三极管的, 通过控制三极管来打开和关闭红外 LED 进行红外信号的发送。

![](/Hardware/part_0601.png) ![](/Hardware/part_0602.png)

PWM 信号分别由单片机 TIM3 的四个通道和 TIM4 的四个通道产生。

## 7. 电路板接口电路

![](/Hardware/part_07.png)

该电路板的接口共有 4 个针脚:

 - 外部电源供电正极
 - 外部电源供电负极
 - 串口信号线 TX
 - 串口信号线 RX

其中串口有两个作用:
 - 串口控制: 电脑通过串口与电路板连接, 发送指令以控制单片机进行学码和发码操作
 - ISP: 电脑通过串口连接单片机来烧写程序。
